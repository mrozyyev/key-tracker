<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <title>Dorm Key Tracker</title>
  <style>
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }
    .toast-enter {
      animation: slideIn 0.3s ease-out;
    }
    .toast-exit {
      animation: slideOut 0.3s ease-in;
    }
    .pulse-ring {
      animation: ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen p-4" x-data="app()" @keydown.escape.window="closeNotifications()">
  <!-- Toast Notifications Container -->
  <div class="fixed top-4 right-4 z-50 space-y-2 max-w-sm w-full">
    <template x-for="(notification, index) in notifications" :key="index">
      <div 
        x-show="notification.visible"
        x-transition:enter="toast-enter"
        x-transition:leave="toast-exit"
        :class="{
          'bg-green-500': notification.type === 'success',
          'bg-red-500': notification.type === 'error',
          'bg-yellow-500': notification.type === 'warning',
          'bg-blue-500': notification.type === 'info'
        }"
        class="text-white px-4 py-3 rounded-lg shadow-lg flex items-center justify-between gap-3"
      >
        <div class="flex items-center gap-2 flex-1">
          <span x-text="notification.icon"></span>
          <span x-text="notification.message" class="text-sm font-medium"></span>
        </div>
        <button @click="removeNotification(index)" class="text-white hover:text-gray-200 font-bold">√ó</button>
      </div>
    </template>
  </div>

  <!-- Footer -->
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 



  <div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
            üîë Dorm Key Tracker
          </h1>
          <p class="text-gray-500 text-sm mt-1">Track and manage key access</p>
        </div>
        <template x-if="user">
          <div class="flex items-center gap-3">
            <button @click="showInstructionsModal = true" class="text-blue-500 hover:text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-50 transition flex items-center gap-2">
              <span>üìã</span>
              <span>Instructions</span>
            </button>
            <button @click="logout()" class="text-red-500 hover:text-red-700 px-3 py-1 rounded-lg hover:bg-red-50 transition">
              Logout
            </button>
          </div>
        </template>
      </div>
    </div>

    <!-- Instructions Modal -->
    <div 
      x-show="showInstructionsModal" 
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
      @click.self="showInstructionsModal = false"
      @keydown.escape.window="showInstructionsModal = false"
      style="display: none;"
    >
      <div 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform scale-95"
        x-transition:enter-end="opacity-100 transform scale-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100 transform scale-100"
        x-transition:leave-end="opacity-0 transform scale-95"
        class="bg-white rounded-2xl shadow-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        @click.stop
      >
        <div class="flex items-start justify-between mb-6">
          <div class="flex items-center gap-3">
            <span class="text-3xl">üìã</span>
            <h2 class="text-2xl font-bold text-gray-800">Essential User Instructions</h2>
          </div>
          <button @click="showInstructionsModal = false" class="text-gray-500 hover:text-gray-700 transition text-2xl">
            √ó
          </button>
        </div>
        
        <div class="space-y-4 text-sm text-gray-700">
          <div class="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-500">
            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span>üîë</span> When Taking the Key
            </h3>
            <ul class="space-y-1 ml-6 list-disc">
              <li>Check if the key is <strong>Available</strong> before taking it</li>
              <li>If someone else has it, click <strong>"Join Queue"</strong> to reserve your spot</li>
              <li>Always <strong>check the queue</strong> - respect others waiting</li>
              <li><strong>‚ö†Ô∏è CRITICAL:</strong> Only click <strong>"I Got the Key"</strong> when you <strong>physically hold the key</strong> in your hand!</li>
            </ul>
          </div>

          <div class="bg-green-50 rounded-lg p-4 border-l-4 border-green-500">
            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span>‚úÖ</span> When You're Using the Key
            </h3>
            <ul class="space-y-1 ml-6 list-disc">
              <li>When finished, click <strong>"Mark as Available"</strong></li>
              <li><strong>Call the next person immediately</strong> if someone is in queue</li>
              <li>The app will show you who to call next</li>
            </ul>
          </div>

          <div class="bg-purple-50 rounded-lg p-4 border-l-4 border-purple-500">
            <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span>üìû</span> When You're Next in Queue
            </h3>
            <ul class="space-y-1 ml-6 list-disc">
              <li><strong>Wait for the call</strong> from the current holder</li>
              <li>You'll see a notification: "You're Next in Queue!"</li>
              <li><strong>ONLY after receiving the key physically</strong> - click <strong>"I Got the Key"</strong></li>
              <li><strong>‚ö†Ô∏è Important:</strong> Do NOT click "I Got the Key" until you physically hold the key!</li>
            </ul>
          </div>

          <div class="bg-yellow-50 rounded-lg p-4 border-l-4 border-yellow-500">
            <p class="font-semibold text-yellow-800 flex items-center gap-2">
              <span>‚ö†Ô∏è</span> Important: Always check the queue and call immediately when marked as available!
            </p>
          </div>
        </div>

        <div class="mt-6 flex justify-end">
          <button @click="showInstructionsModal = false" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold transition">
            Got it!
          </button>
        </div>
      </div>
    </div>

    <!-- Auth Section -->
    <template x-if="!user">
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <div class="text-center mb-6">
          <div class="inline-block p-4 bg-blue-100 rounded-full mb-4">
            <span class="text-4xl">üì±</span>
          </div>
          <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome Back</h2>
          <p class="text-gray-600">Enter your phone number to continue</p>
        </div>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
            <input 
              x-model="phoneInput" 
              type="tel" 
              placeholder="Enter your phone number"
              @keydown.enter="login()"
              class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition"
            >
            <div class="mt-2 bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-800">
              <p class="font-semibold mb-1">Login instructions</p>
              <ul class="list-disc ml-5 space-y-1">
                <li>Use your phone number registered on WhatsApp</li>
                <li>Format: starts with <span class="font-semibold">40</span> (example: 407xxxxxxx)</li>
                <li>If you can't login, request registration in the <span class="font-semibold">Key-Wars</span> WhatsApp group</li>
              </ul>
              <div class="mt-2">
                <a :href="getCantLoginLink()" target="_blank" rel="noopener"
                   class="inline-flex items-center gap-2 text-sm text-green-700 hover:text-green-900 font-semibold">
                  <span>üí¨</span>
                  <span>Can't login? Ask to register</span>
                </a>
              </div>
            </div>
          </div>
          <button 
            @click="login()" 
            :disabled="loading"
            class="w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg hover:shadow-xl"
          >
            <span x-show="!loading">Continue</span>
            <span x-show="loading">Loading...</span>
          </button>
        </div>
      </div>
    </template>

    <!-- Main App -->
    <template x-if="user">
      <div class="space-y-6">
        <!-- User Info Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                <span x-text="user.name.charAt(0).toUpperCase()"></span>
              </div>
              <div>
                <h3 class="text-xl font-bold text-gray-800" x-text="user.name"></h3>
                <p class="text-gray-600 text-sm">Room <span x-text="user.room"></span> ‚Ä¢ <span x-text="user.phone"></span></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Key Status Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-800">Key Status</h2>
            <button @click="refreshData()" class="text-gray-500 hover:text-gray-700 transition" :disabled="loading">
              <span class="text-xl">üîÑ</span>
            </button>
          </div>

          <div class="space-y-4">
            <!-- Status Badge -->
            <div class="flex items-center justify-center">
              <div 
                :class="{
                  'bg-green-100 border-green-500 text-green-700': status.Status === 'Available',
                  'bg-red-100 border-red-500 text-red-700': status.Status === 'Using' || status.Status === 'Taken',
                  'bg-yellow-100 border-yellow-500 text-yellow-700': status.Status === 'Reserved'
                }"
                class="px-6 py-3 rounded-full border-2 font-bold text-lg flex items-center gap-2"
              >
                <template x-if="status.Status === 'Available'">
                  <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                  </span>
                </template>
                <template x-if="status.Status === 'Using' || status.Status === 'Taken'">
                  <span class="relative flex h-3 w-3">
                    <span class="animate-pulse absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                  </span>
                </template>
                <span x-text="(status.Status === 'Taken' ? 'Using' : status.Status) || 'Loading...'"></span>
              </div>
            </div>

            <!-- Status Details -->
            <div class="bg-gray-50 rounded-lg p-4 space-y-3">
              <div class="flex items-center justify-between">
                <span class="text-gray-600 flex items-center gap-2">
                  <span>üôã</span> Current Holder
                </span>
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-gray-800" x-text="status.HolderName || 'None'"></span>
                  <template x-if="status.HolderPhone && status.HolderPhone.trim() !== ''">
                    <a :href="'tel:' + status.HolderPhone" class="text-blue-600 hover:text-blue-800 text-sm flex items-center gap-1 hover:underline font-semibold">
                      <span>üìû</span>
                      <span x-text="status.HolderPhone"></span>
                    </a>
                  </template>
                  <template x-if="status.HolderPhone && status.HolderPhone.trim() !== ''">
                    <a 
                      :href="getWhatsAppLinkToHolder()"
                      target="_blank"
                      rel="noopener"
                      class="text-green-600 hover:text-green-800 text-sm flex items-center gap-1 font-semibold"
                      title="Message holder on WhatsApp"
                    >
                      <span>üí¨</span>
                      <span>WhatsApp</span>
                    </a>
                  </template>
                </div>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-gray-600 flex items-center gap-2">
                  <span>‚è∞</span> Since
                </span>
                <span class="font-semibold text-gray-800" x-text="formatDate(status.TakenAt) || 'N/A'"></span>
              </div>
              <template x-if="status.Note">
                <div class="flex items-start justify-between pt-2 border-t border-gray-200">
                  <span class="text-gray-600 flex items-center gap-2">
                    <span>üìù</span> Note
                  </span>
                  <span class="font-semibold text-gray-800 text-right max-w-xs" x-text="status.Note"></span>
                </div>
              </template>
            </div>
            
            <!-- Next in Queue Alert when Available -->
            <template x-if="status.Status === 'Available' && queue.length > 0 && getCurrentPersonToCall() && normalizePhone(getCurrentPersonToCall().Phone) === normalizePhone(user.phone)">
              <div class="bg-blue-100 border-2 border-blue-500 rounded-lg p-4 mt-4">
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-3xl">üìû</span>
                  <div>
                    <h3 class="font-bold text-blue-900">You're Next in Queue!</h3>
                    <p class="text-sm text-blue-700">
                      <span x-text="status.HolderName || 'Someone'"></span> marked the key as available.
                      <template x-if="status.HolderPhone && status.HolderPhone.trim() !== ''">
                        Call them at <a :href="'tel:' + status.HolderPhone" class="font-semibold underline"><span x-text="status.HolderPhone"></span></a> to get the key.
                      </template>
                    </p>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Queue Section -->
        <template x-if="queue && queue.length > 0">
          <div class="bg-white rounded-2xl shadow-xl p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Waiting Queue</h2>
            <div class="space-y-2">
              <template x-for="(person, index) in queue" :key="index">
                <div class="p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm" x-text="index + 1"></div>
                      <div>
                        <p class="font-semibold text-gray-800" x-text="person.Name"></p>
                        <div class="flex items-center gap-2">
                          <a :href="'tel:' + person.Phone" class="text-xs text-blue-600 hover:text-blue-800 font-semibold flex items-center gap-1 hover:underline">
                            <span>üìû</span>
                            <span x-text="person.Phone"></span>
                          </a>
                        </div>
                      </div>
                    </div>
                    <span class="text-xs text-gray-500" x-text="formatDate(person.QueuedAt)"></span>
                  </div>
                  <template x-if="person.Note && person.Note.trim() !== ''">
                    <div class="mt-2 pt-2 border-t border-gray-200">
                      <p class="text-xs text-gray-600">
                        <span class="font-semibold">Note:</span>
                        <span x-text="person.Note"></span>
                      </p>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </div>
        </template>

        <!-- Actions Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Actions</h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Add Note (Optional)</label>
              <textarea 
                x-model="note" 
                placeholder="Enter any notes about the key..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition resize-none"
                rows="3"
              ></textarea>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <!-- Available Status Actions - Only show if not the holder -->
              <template x-if="status.Status === 'Available' && normalizePhone(status.HolderPhone) !== normalizePhone(user.phone)">
                <div class="col-span-2 space-y-2">
                  <div class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-3">
                    <p class="text-xs font-semibold text-yellow-800 flex items-center gap-2">
                      <span>‚ö†Ô∏è</span>
                      <span>ONLY click "I Got the Key" if you <strong>physically hold the key</strong> in your hand right now!</span>
                    </p>
                  </div>
                  <button 
                    @click="takeKey()" 
                    :disabled="loading || !user"
                    class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-emerald-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg hover:shadow-xl flex items-center justify-center gap-2"
                  >
                    <span>‚úì</span>
                    <span>I Got the Key</span>
                  </button>
                </div>
              </template>
              
              <template x-if="status.Status === 'Available' && normalizePhone(status.HolderPhone) !== normalizePhone(user.phone) && !isInQueue()">
                <button 
                  @click="joinQueue()" 
                  :disabled="loading || !user"
                  class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg hover:shadow-xl flex items-center justify-center gap-2"
                >
                  <span>üìã</span>
                  <span>Join Queue</span>
                </button>
              </template>
              
              <!-- Current Holder Actions (Status = Using or Taken) -->
              <template x-if="(status.Status === 'Using' || status.Status === 'Taken') && normalizePhone(status.HolderPhone) === normalizePhone(user.phone)">
                <div class="col-span-2 space-y-2">
                  <!-- Mark as Available Button -->
                  <button 
                    @click="markAvailable()" 
                    :disabled="loading || !user"
                    class="w-full bg-gradient-to-r from-orange-500 to-amber-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-orange-600 hover:to-amber-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg hover:shadow-xl flex items-center justify-center gap-2"
                  >
                    <span>‚úì</span>
                    <span>Mark as Available</span>
                  </button>
                  
                  <!-- Show next person to call after marking available -->
                  <template x-if="queue.length > 0 && getCurrentPersonToCall()">
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 text-center space-y-2">
                      <p class="text-sm font-semibold text-blue-800 mb-2">
                        üìû Next person to call: <span x-text="getCurrentPersonToCall().Name"></span>
                      </p>
                      <div class="flex justify-center gap-2">
                        <a 
                          :href="getWhatsAppLink(getCurrentPersonToCall().Phone, getCurrentPersonToCall().Name)"
                          target="_blank"
                          rel="noopener"
                          class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition"
                        >
                          üí¨ WhatsApp <span x-text="getCurrentPersonToCall().Name"></span>
                        </a>
                        <a 
                          :href="'tel:' + getCurrentPersonToCall().Phone" 
                          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition"
                        >
                          üìû Call <span x-text="getCurrentPersonToCall().Name"></span>
                        </a>
                      </div>
                    </div>
                  </template>
                  
                  <template x-if="queue.length === 0">
                    <p class="text-xs text-center text-gray-600">
                      No one in queue - anyone can take the key when you mark it available.
                    </p>
                  </template>
                </div>
              </template>

              <!-- Available Status - Holder has key ready to hand off -->
              <template x-if="status.Status === 'Available' && normalizePhone(status.HolderPhone) === normalizePhone(user.phone)">
                <div class="col-span-2 space-y-2">
                  <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3 text-center space-y-2 mb-2">
                    <p class="text-sm font-semibold text-green-800 mb-2">
                      ‚úì Key marked as Available - Ready to hand off
                    </p>
                    <template x-if="queue.length > 0 && getCurrentPersonToCall()">
                      <p class="text-xs text-green-700 mb-2">
                        Next person: <span x-text="getCurrentPersonToCall().Name"></span>
                      </p>
                    </template>
                  </div>
                  
                  <template x-if="queue.length > 0 && getCurrentPersonToCall()">
                    <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 text-center space-y-2">
                      <p class="text-sm font-semibold text-blue-800 mb-2">
                        üìû Call <span x-text="getCurrentPersonToCall().Name"></span> to collect the key
                      </p>
                      <div class="flex justify-center gap-2">
                        <a 
                          :href="getWhatsAppLink(getCurrentPersonToCall().Phone, getCurrentPersonToCall().Name)"
                          target="_blank"
                          rel="noopener"
                          class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition"
                        >
                          üí¨ WhatsApp <span x-text="getCurrentPersonToCall().Name"></span>
                        </a>
                        <a 
                          :href="'tel:' + getCurrentPersonToCall().Phone" 
                          class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition"
                        >
                          üìû Call <span x-text="getCurrentPersonToCall().Name"></span>
                        </a>
                      </div>
                    </div>
                  </template>
                  
                  <template x-if="queue.length === 0">
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-3 text-center">
                      <p class="text-sm font-semibold text-yellow-800">
                        No one in queue - anyone can take the key now.
                      </p>
                    </div>
                  </template>
                </div>
              </template>

              <!-- Using Status - Not holder -->
              <template x-if="(status.Status === 'Using' || status.Status === 'Taken') && normalizePhone(status.HolderPhone) !== normalizePhone(user.phone) && !isInQueue()">
                <button 
                  @click="joinQueue()" 
                  :disabled="loading || !user"
                  class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-pink-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg hover:shadow-xl flex items-center justify-center gap-2 col-span-2"
                >
                  <span>üìã</span>
                  <span>Join Queue</span>
                </button>
              </template>

              <template x-if="isInQueue()">
                <button 
                  @click="leaveQueue()" 
                  :disabled="loading || !user"
                  class="bg-gradient-to-r from-red-500 to-rose-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-red-600 hover:to-rose-600 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg hover:shadow-xl flex items-center justify-center gap-2 col-span-2"
                >
                  <span>‚úï</span>
                  <span>Leave Queue</span>
                </button>
              </template>
            </div>
          </div>
        </div>

        <!-- History Card -->
        <div class="bg-white rounded-2xl shadow-xl p-6">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Recent History</h2>
          <div class="space-y-2 max-h-96 overflow-y-auto">
            <template x-if="history.length === 0">
              <p class="text-center text-gray-500 py-4">No history available</p>
            </template>
            <template x-for="(item, index) in history" :key="index">
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                <div class="flex items-center gap-3">
                  <div 
                    :class="{
                      'bg-green-100 text-green-700': item.Action === 'Take',
                      'bg-blue-100 text-blue-700': item.Action === 'Return' || item.Action === 'Available',
                      'bg-purple-100 text-purple-700': item.Action === 'Queue'
                    }"
                    class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm"
                  >
                    <span x-text="item.Action === 'Take' ? '‚úì' : item.Action === 'Return' ? 'üîô' : item.Action === 'Available' ? '‚úì' : 'üìã'"></span>
                  </div>
                  <div>
                    <p class="font-semibold text-gray-800" x-text="item.Name"></p>
                    <p class="text-sm text-gray-600" x-text="item.Action === 'Take' ? 'Got the key' : item.Action === 'Available' ? 'Marked as available' : item.Action + ' key'"></p>
                  </div>
                </div>
                <span class="text-xs text-gray-500" x-text="formatDate(item.Timestamp)"></span>
              </div>
            </template>
          </div>
        </div>
      </div>
    </template>
  <footer class="mt-10 max-w-2xl mx-auto">
      <div class="bg-white rounded-2xl shadow p-4 flex items-center justify-between gap-4">
        <div class="flex-1">
          <p class="text-sm text-gray-600 mb-2">
            Learn or push improvements on GitHub ‚Äî if this project is helpful, support me with a coffee :D ‚òï
          </p>
          <a href="https://github.com/mrozyyev/key-tracker" target="_blank" rel="noopener"
             class="inline-flex items-center gap-2 px-4 py-3 rounded-lg border border-gray-200 bg-gray-900 text-white hover:bg-black shadow">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" class="w-5 h-5 fill-current"><path d="M12 2C6.477 2 2 6.486 2 12.021c0 4.425 2.865 8.18 6.839 9.504.5.092.683-.217.683-.483 0-.238-.009-.868-.014-1.704-2.782.607-3.369-1.345-3.369-1.345-.454-1.155-1.11-1.463-1.11-1.463-.907-.62.069-.607.069-.607 1.003.071 1.53 1.032 1.53 1.032.892 1.53 2.341 1.088 2.91.832.091-.65.35-1.088.636-1.34-2.222-.254-4.555-1.114-4.555-4.956 0-1.094.39-1.99 1.029-2.69-.103-.254-.446-1.276.098-2.66 0 0 .84-.27 2.75 1.027A9.564 9.564 0 0 1 12 7.07c.85.004 1.705.115 2.505.338 1.909-1.296 2.748-1.027 2.748-1.027.545 1.384.202 2.406.1 2.66.64.7 1.027 1.596 1.027 2.69 0 3.852-2.337 4.699-4.566 4.949.359.31.679.923.679 1.86 0 1.344-.012 2.427-.012 2.757 0 .268.18.58.69.481A10.02 10.02 0 0 0 22 12.021C22 6.486 17.523 2 12 2Z"/></svg>
            <span class="text-sm font-semibold">View Project on GitHub</span>
          </a>
        </div>
        <div class="flex items-center">
          <noscript>
            <a href="https://www.buymeacoffee.com/mrozyyev" class="text-sm text-gray-700 hover:text-gray-900">Buy me a coffee</a>
          </noscript>
          <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="mrozyyev" data-color="#FFDD00" data-emoji="‚òï"  data-font="Poppins" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff"></script>
        </div>
      </div>
    </footer>
  </div>

  <script>
    function app() {
      const baseURL = "https://script.google.com/macros/s/AKfycbxiCkD5qG8ncr4gzKJstHMCEM1sABHZbc2a3b5baLC-GapiHdQqTD_O7xNqcaP5ZKE/exec";
      const whatsappGroupUrl = "https://chat.whatsapp.com/REPLACE_WITH_INVITE"; // Optional: set your Key-Wars group invite link

      return {
        phoneInput: "",
        user: JSON.parse(localStorage.getItem('user') || 'null'),
        status: {},
        history: [],
        queue: [],
        note: "",
        loading: false,
        notifications: [],
        showInstructionsModal: false,

        async init() {
          if (this.user) {
            await this.refreshData();
            // Auto-refresh every 30 seconds
            setInterval(() => this.refreshData(), 30000);
          }
        },

        formatDate(dateString) {
          if (!dateString) return 'N/A';
          
          try {
            // Handle ISO format dates
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
              // If it's already a formatted string, return as is
              return dateString;
            }
            
            // Format as readable date/time
            return date.toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
          } catch (e) {
            return dateString;
          }
        },

        showNotification(message, type = 'info') {
          const icons = {
            success: '‚úì',
            error: '‚úï',
            warning: '‚ö†',
            info: '‚Ñπ'
          };
          
          const notification = {
            message,
            type,
            icon: icons[type],
            visible: true,
            id: Date.now()
          };
          
          this.notifications.push(notification);
          
          // Auto remove after 5 seconds
          setTimeout(() => {
            const index = this.notifications.findIndex(n => n.id === notification.id);
            if (index !== -1) {
              this.notifications[index].visible = false;
              setTimeout(() => this.notifications.splice(index, 1), 300);
            }
          }, 5000);
        },

        getCantLoginLink() {
          // If a WhatsApp group invite link is configured, use it; otherwise fallback to a generic message
          if (whatsappGroupUrl && !/REPLACE_WITH_INVITE/.test(whatsappGroupUrl)) {
            return whatsappGroupUrl;
          }
          const text = 'Hello, please register my number for the Key-Wars key tracker.';
          return `https://wa.me/?text=${encodeURIComponent(text)}`;
        },

        removeNotification(index) {
          this.notifications[index].visible = false;
          setTimeout(() => this.notifications.splice(index, 1), 300);
        },

        closeNotifications() {
          this.notifications.forEach(n => n.visible = false);
          setTimeout(() => this.notifications = [], 300);
        },

        async login() {
          if (!this.phoneInput.trim()) {
            this.showNotification('Please enter your phone number', 'error');
            return;
          }

          this.loading = true;
          try {
            // Normalize phone input (remove spaces, dashes, parentheses)
            const normalizedInput = this.phoneInput.trim().replace(/[\s\-\(\)]/g, '');
            const digitsOnly = normalizedInput.replace(/\D/g, '');
            if (!digitsOnly.startsWith('40')) {
              this.showNotification('Tip: Phone numbers should start with 40 and match your WhatsApp number', 'warning');
            }
            
            const res = await fetch(`${baseURL}?action=users`);
            
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            
            const users = await res.json();
            
            // Log for debugging
            console.log('Users fetched:', users);
            console.log('Searching for phone:', normalizedInput);
            
            if (!users || !Array.isArray(users)) {
              throw new Error('Invalid users data received');
            }
            
            // Normalize phone numbers for comparison (remove spaces, dashes, parentheses)
            const found = users.find(u => {
              const normalizedPhone = String(u.Phone || '').trim().replace(/[\s\-\(\)]/g, '');
              return normalizedPhone === normalizedInput || u.Phone === this.phoneInput.trim();
            });
            
            if (!found) {
              this.showNotification('Phone number not registered. Please check your phone number.', 'error');
              console.log('Available phones:', users.map(u => u.Phone));
              this.loading = false;
              return;
            }

            this.user = { phone: found.Phone, name: found.Name, room: found.RoomNumber };
            localStorage.setItem('user', JSON.stringify(this.user));
            this.showNotification(`Welcome ${found.Name}!`, 'success');
            await this.refreshData();
          } catch (error) {
            console.error('Login error:', error);
            this.showNotification(`Login failed: ${error.message || 'Please check your connection and try again.'}`, 'error');
          } finally {
            this.loading = false;
          }
        },

        logout() {
          this.user = null;
          this.status = {};
          this.history = [];
          this.queue = [];
          localStorage.removeItem('user');
          this.showNotification('Logged out successfully', 'info');
        },

        async refreshData() {
          try {
            await Promise.all([
              this.loadStatus(),
              this.loadHistory(),
              this.loadQueue()
            ]);
            
            // Debug info
            if (this.user && this.status) {
              console.log('User phone:', this.user.phone, 'Normalized:', this.normalizePhone(this.user.phone));
              console.log('Holder phone:', this.status.HolderPhone, 'Normalized:', this.normalizePhone(this.status.HolderPhone));
              console.log('Status:', this.status.Status);
              console.log('Is holder?', this.normalizePhone(this.status.HolderPhone) === this.normalizePhone(this.user.phone));
              console.log('Queue length:', this.queue?.length || 0);
              console.log('Is in queue?', this.isInQueue());
            }
          } catch (error) {
            console.error('Refresh error:', error);
          }
        },

        async loadStatus() {
          try {
            const res = await fetch(`${baseURL}?action=status`);
            this.status = await res.json();
          } catch (error) {
            console.error('Load status error:', error);
            this.showNotification('Failed to load status', 'error');
          }
        },

        async loadHistory() {
          try {
            const res = await fetch(`${baseURL}?action=history`);
            this.history = await res.json() || [];
          } catch (error) {
            console.error('Load history error:', error);
          }
        },

        async loadQueue() {
          try {
            const res = await fetch(`${baseURL}?action=queue`);
            this.queue = await res.json() || [];
          } catch (error) {
            // Queue endpoint might not exist, that's okay
            console.log('Queue endpoint not available');
          }
        },

        normalizePhone(phone) {
          return String(phone || '').trim().replace(/[\s\-\(\)]/g, '');
        },

        isInQueue() {
          if (!this.user || !this.queue) return false;
          const userPhone = this.normalizePhone(this.user.phone);
          return this.queue.some(q => this.normalizePhone(q.Phone) === userPhone);
        },

        getWhatsAppLink(phone, name) {
          const digits = this.normalizePhone(phone);
          const message = `hey ${name} key is available to take/use. let's meet and I'll give you the key; remember to mark you got the key when you receive it, or when you finish using it mark complete and follow the same steps: write or call the next person to hand out here https://key-tracker.pages.dev/`;
          return `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
        },

        getWhatsAppLinkToHolder() {
          const phone = this.status?.HolderPhone;
          if (!phone) return '#';
          const digits = this.normalizePhone(phone);
          const holderName = this.status?.HolderName || '';
          const sender = this.user?.name ? ` I'm ${this.user.name}.` : '';
          const message = `Hi ${holderName}, when can I get the key?${sender} Thanks!`;
          return `https://wa.me/${digits}?text=${encodeURIComponent(message)}`;
        },

        getCurrentPersonToCall() {
          if (!this.queue || this.queue.length === 0) return null;
          const currentIndex = this.status.CurrentCallIndex || 0;
          return this.queue[currentIndex] || null;
        },

        async takeKey() {
          if (!this.user) {
            this.showNotification('Please log in first', 'error');
            return;

          }

          if (this.status.Status !== "Available") {
            this.showNotification(`Key already taken by ${this.status.HolderName}`, 'warning');
            return;
          }

          this.loading = true;
          try {
            const formData = new URLSearchParams();
            formData.append('action', 'take');
            formData.append('phone', this.user.phone);
            formData.append('name', this.user.name);
            formData.append('note', this.note || '');
            
            const res = await fetch(baseURL, { 
              method: "POST", 
              mode: 'cors',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: formData.toString()
            });
            
            const result = await res.json();
            
            if (result.success !== false) {
              this.showNotification('Key taken successfully!', 'success');
              this.note = '';
              await this.refreshData();
            } else {
              this.showNotification(result.message || 'Failed to take key', 'error');
            }
          } catch (error) {
            this.showNotification('Error taking key. Please try again.', 'error');
            console.error('Take key error:', error);
          } finally {
            this.loading = false;
          }
        },

        async returnKey() {
          if (!this.user) {
            this.showNotification('Please log in first', 'error');
            return;
          }

          if (this.normalizePhone(this.status.HolderPhone) !== this.normalizePhone(this.user.phone)) {
            this.showNotification(`Only the current holder can return the key! Current: ${this.status.HolderPhone}, You: ${this.user.phone}`, 'error');
            return;
          }

          this.loading = true;
          try {
            const formData = new URLSearchParams();
            formData.append('action', 'return');
            formData.append('phone', this.user.phone);
            formData.append('name', this.user.name);
            formData.append('note', this.note || '');
            
            const res = await fetch(baseURL, { 
              method: "POST", 
              mode: 'cors',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: formData.toString()
            });
            
            const result = await res.json();
            
            if (result.success !== false) {
              this.showNotification('Key returned successfully!', 'success');
              this.note = '';
              await this.refreshData();
            } else {
              this.showNotification(result.message || 'Failed to return key', 'error');
            }
          } catch (error) {
            this.showNotification('Error returning key. Please try again.', 'error');
            console.error('Return key error:', error);
          } finally {
            this.loading = false;
          }
        },

        async joinQueue() {
          if (!this.user) {
            this.showNotification('Please log in first', 'error');
            return;
          }

          if (this.isInQueue()) {
            this.showNotification('You are already in the queue', 'warning');
            return;
          }

          this.loading = true;
          try {
            const formData = new URLSearchParams();
            formData.append('action', 'queue');
            formData.append('phone', this.user.phone);
            formData.append('name', this.user.name);
            formData.append('operation', 'join');
            formData.append('note', this.note || '');
            
            const res = await fetch(baseURL, { 
              method: "POST", 
              mode: 'cors',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: formData.toString()
            });
            
            const result = await res.json();
            
            if (result.success !== false) {
              this.showNotification('Joined queue successfully!', 'success');
              this.note = '';
              await this.refreshData();
            } else {
              this.showNotification(result.message || 'Failed to join queue', 'error');
            }
          } catch (error) {
            this.showNotification('Error joining queue. Please try again.', 'error');
            console.error('Join queue error:', error);
          } finally {
            this.loading = false;
          }
        },

        async leaveQueue() {
          if (!this.user) {
            this.showNotification('Please log in first', 'error');
            return;
          }

          if (!this.isInQueue()) {
            this.showNotification('You are not in the queue', 'warning');
            return;
          }

          this.loading = true;
          try {
            const formData = new URLSearchParams();
            formData.append('action', 'queue');
            formData.append('phone', this.user.phone);
            formData.append('name', this.user.name);
            formData.append('operation', 'leave');
            
            const res = await fetch(baseURL, { 
              method: "POST", 
              mode: 'cors',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: formData.toString()
            });
            
            const result = await res.json();
            
            if (result.success !== false) {
              this.showNotification('Left queue successfully', 'info');
              await this.refreshData();
            } else {
              this.showNotification(result.message || 'Failed to leave queue', 'error');
            }
          } catch (error) {
            this.showNotification('Error leaving queue. Please try again.', 'error');
            console.error('Leave queue error:', error);
          } finally {
            this.loading = false;
          }
        },

        async markAvailable() {
          if (!this.user) {
            this.showNotification('Please log in first', 'error');
            return;
          }

          if (this.normalizePhone(this.status.HolderPhone) !== this.normalizePhone(this.user.phone)) {
            this.showNotification(`Only the current holder can mark it as available. Current: ${this.status.HolderPhone}, You: ${this.user.phone}`, 'error');
            return;
          }

          // Accept both 'Using' and 'Taken' for backward compatibility
          if (this.status.Status !== 'Using' && this.status.Status !== 'Taken') {
            this.showNotification('Key must be in use to mark as available', 'warning');
            return;
          }

          this.loading = true;
          try {
            const formData = new URLSearchParams();
            formData.append('action', 'available');
            formData.append('phone', this.user.phone);
            formData.append('name', this.user.name);
            formData.append('note', this.note || '');
            
            const res = await fetch(baseURL, { 
              method: "POST", 
              mode: 'cors',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: formData.toString()
            });
            
            const result = await res.json();
            
            if (result.success !== false) {
              this.showNotification(result.message || 'Key marked as available', 'success');
              this.note = '';
              await this.refreshData();
            } else {
              this.showNotification(result.message || 'Failed to mark available', 'error');
            }
          } catch (error) {
            this.showNotification('Error marking available. Please try again.', 'error');
            console.error('Mark available error:', error);
          } finally {
            this.loading = false;
          }
        },

      };
    }
  </script>
</body>
</html>
